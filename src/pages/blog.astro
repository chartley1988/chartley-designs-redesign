---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import summary from "../data/summary";

const blogPosts = await getCollection("blog");
---

<Layout title={`${summary.siteName} - Blog`}>
	<div class='container blog'>
		<h1>Blog</h1>

		<ul id='blog-post-list'></ul>

		<div id='blog-nav-links'>
			<!-- Previous, Index, Next -->
		</div>
	</div>
</Layout>

<script define:vars={{ blogPosts }}>
	const urlString = window.location.search;
	const params = new URLSearchParams(urlString);

	// Page Number
	let page = params.get("page");
	if (page === null || page <= 0) page = "1";

	// How many items to show per page
	let quantity = params.get("show");
	if (quantity === null) quantity = "10";

	// Determine Range of items to show
	const firstItem = Number(page) * Number(quantity) - quantity;
	const lastItem = Number(page) * Number(quantity) - 1;

	console.log(blogPosts);
	// Sort blogPosts, by default, sort by date
	blogPosts.sort(function (a, b) {
		return new Date(b.data.date) - new Date(a.data.date);
	});
	console.log(blogPosts);

	// Narrow the posts down to range
	const displayedPosts = blogPosts.filter((entry) => {
		const index = blogPosts.indexOf(entry);
		if (index >= firstItem && index <= lastItem) {
			return entry;
		}
	});

	const list = document.getElementById("blog-post-list");

	displayedPosts.forEach((post) => {
		const container = document.createElement("li");
		container.className = "blog-post-list-item";

		const header = document.createElement("div");
		header.className = "blog-post-header";
		container.append(header);

		const anchor = document.createElement("a");
		anchor.setAttribute("href", `/blog/${post.data.url}`);
		anchor.textContent = `${post.data.title}`;
		header.append(anchor);

		const description = document.createElement("p");
		description.textContent = `${post.data.summary}`;
		container.append(description);

		const date = document.createElement("p");
		date.textContent = `${post.data.date.slice(0, 10)}`;
		header.append(date);

		list.append(container);
	});

	const navContainer = document.getElementById("blog-nav-links");

	// Logic for adding a prev page button
	if (Number(page) === 1) {
		const link = document.createElement('p');
		link.textContent = "Previous Page";
		navContainer.append(link);
	} else {
		const prevTarget = Number(page) - 1;
		const link = document.createElement("a");
		link.setAttribute("href", `/blog?page=${prevTarget}`);
		link.textContent = "Previous Page"
		navContainer.append(link);
	}
	
	// Logic for adding a next page button
	if (displayedPosts.length < quantity) {
		const link = document.createElement('p');
		link.textContent = "Next Page";
		navContainer.append(link);
	} else {
		const nextTarget = Number(page) + 1;
		const link = document.createElement('a');
		link.setAttribute("href", `/blog?page=${nextTarget}`);
		link.textContent = "Next Page"
		navContainer.append(link);
	}

</script>

<style is:global>
	#blog-post-list {
		display: flex;
		flex-direction: column;
		gap: 1rem;
		flex: 1;
		height: 100%;
	}

	#blog-nav-links {
		display: flex;
		flex-direction: row;
		justify-content: space-between;
		margin: 2rem 0;
	}

	.blog {
		display: flex;
		flex-direction: column;
		height: 100%;
		justify-content: space-between;
		flex: 1;
	}

	.blog-post-list-item {
		list-style: none;
	}

	.blog-post-header {
		display: flex;
		flex-direction: column;
	}

	@media (min-width: 1024px) {
		.blog-post-header {
			flex-direction: row;
			justify-content: space-between;
		}
	}
</style>
